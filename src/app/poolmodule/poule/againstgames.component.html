<div class="row justify-content-center g-0">
    <div class="col-xs-12 col-sm-10 col-md-8 col-lg-6">

        <div class="d-flex justify-content-between mt-2">
            <h2 class="ms-3" [ngClass]="{'pointer': pool}" (click)="navigateToStructure()">
                <app-superelf-icon [name]="cssService.getIconName(leagueName)"></app-superelf-icon>
                <span class="ms-1">{{nameService.getLeagueName(leagueName)}}</span>
            </h2>
            <div>
                <button *ngIf="poolPoule" (click)="navigateToChat(poolPoule)" type="button"
                    class="btn btn-outline-dark me-3 position-relative">
                    <fa-icon [icon]="['fas', 'message']"></fa-icon>
                    <span class="ms-1"> chat</span>
                    <span *ngIf="nrOfUnreadMessages > 0"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{nrOfUnreadMessages}}
                        <span class="visually-hidden">ongelezen berichten</span>
                    </span>
                </button>
            </div>
        </div>

        <h2 *ngIf="processing" class="text-center">
            <fa-icon [icon]="['fas', 'spinner']" [spin]="true"></fa-icon>
        </h2>

        <div *ngIf="!processing && poolPoule && homeCompetitor && awayCompetitor">
            <h2 class="d-flex justify-content-center">
                <app-poule-title [poule]="poolPoule" [poolCompetitors]="pool.getCompetitors(leagueName)">
                </app-poule-title>
            </h2>

            <div class="d-flex justify-content-center mt-2">
                <app-gameround-scroller [gameRounds]="gameRounds" [current]="currentGameRound"
                    (update)="updateGameRound($event)">
                </app-gameround-scroller>
            </div>

            <h2 *ngIf="!processing && processingGameRound" class="text-center">
                <fa-icon [icon]="['fas', 'spinner']" [spin]="true"></fa-icon>
            </h2>
            <table class="table" *ngIf="currentGameRound && !processingGameRound">
                <tbody *ngFor="let sourceGame of sourceGames; let first = first;">
                    <tr *ngIf="first" class="fs-5">
                        <td class="border-bottom-0 pt-3 pb-0"></td>
                        <td class="border-bottom-0 text-end pt-3 pb-0 ps-0">
                            <a [routerLink]="['/pool/user', homeCompetitor.getPoolUser().getPool().getId(), homeCompetitor.getPoolUser().getId(), currentGameRound.getNumber()]"
                                *ngIf="getCurrentPoolGame(currentGameRound)?.getState() !== Created"
                                class="badge bg-totals">
                                {{getPoolGamePoints(currentGameRound, homeCompetitor)}}</a>
                        </td>
                        <td class="border-bottom-0 pt-3 pb-0 pe-0">
                            <a [routerLink]="['/pool/user', awayCompetitor.getPoolUser().getPool().getId(), awayCompetitor.getPoolUser().getId(), currentGameRound.getNumber()]"
                                *ngIf="getCurrentPoolGame(currentGameRound)?.getState() !== Created"
                                class="badge bg-totals">
                                {{getPoolGamePoints(currentGameRound, awayCompetitor)}}</a>
                        </td>
                        <td class="border-bottom-0 pt-3 pb-0"></td>
                    </tr>
                    <tr>
                        <td class="border-bottom-0 pt-3 pb-0 text-end">
                            <span *ngFor="let sideCompetitor of getCompetitors(sourceGame, HomeSide)">
                                <app-team-name *ngIf="isTeamCompetitor(sideCompetitor)" [team]="getTeam(sideCompetitor)"
                                    class="d-flex flex-row-reverse"></app-team-name>
                            </span>
                        </td>
                        <td colspan="2" class="border-bottom-0 text-center pt-3 pb-0">
                            <a
                                [routerLink]="['/pool/sourcegame', pool.getId(), sourceGame.getGameRoundNumber(), sourceGame.getId()]">
                                <ng-container *ngIf="sourceGame.getState() === Finished;else notFinished">
                                    {{nameService.getAgainstScore(sourceGame)}}
                                </ng-container>
                                <ng-template #notFinished>

                                    <ng-container *ngIf="isToday(sourceGame.getStartDateTime());else afterToday">
                                        {{dateFormatter.toString(sourceGame.getStartDateTime(),dateFormatter.time())}}
                                    </ng-container>
                                    <ng-template #afterToday>
                                        {{dateFormatter.toString(sourceGame.getStartDateTime(),dateFormatter.date())}}
                                    </ng-template>

                                </ng-template>

                            </a>

                        </td>
                        <td class="border-bottom-0 pt-3 pb-0">
                            <span *ngFor="let sideCompetitor of getCompetitors(sourceGame, AwaySide)">
                                <app-team-name *ngIf="isTeamCompetitor(sideCompetitor)"
                                    [team]="getTeam(sideCompetitor)"></app-team-name>
                            </span>

                        </td>


                    </tr>

                    <ng-container *ngFor="let team of getTeams(sourceGame)">
                        <tr *ngFor="let formationPlacesLine of getFormationPlacesLines(sourceGame, team)">
                            <td class="text-end">
                                <ng-container [ngTemplateOutlet]="contentForamtionPlace"
                                    [ngTemplateOutletContext]="{formationPlace: formationPlacesLine.home, away: true}">
                                </ng-container>
                            </td>
                            <td class="text-end">
                                <ng-container [ngTemplateOutlet]="contentForamtionPlaceScore"
                                    [ngTemplateOutletContext]="{formationPlace: formationPlacesLine.home, sourceGame}">
                                </ng-container>
                            </td>
                            <td>
                                <ng-container [ngTemplateOutlet]="contentForamtionPlaceScore"
                                    [ngTemplateOutletContext]="{formationPlace: formationPlacesLine.away, sourceGame}">
                                </ng-container>
                            </td>
                            <td>
                                <ng-container [ngTemplateOutlet]="contentForamtionPlace"
                                    [ngTemplateOutletContext]="{formationPlace: formationPlacesLine.away}">
                                </ng-container>
                            </td>
                        </tr>
                    </ng-container>

                </tbody>

            </table>

            <ng-template #contentForamtionPlace let-formationPlace="formationPlace" let-away="away">
                <ng-container *ngIf="formationPlace">
                    <div class="d-flex align-items-start" [ngClass]="{'flex-row-reverse': away}">

                        <app-lineicon *ngIf="formationPlace.getPlayer()" [line]="formationPlace.getPlayer().getLine()">
                        </app-lineicon>
                        <ng-container [ngTemplateOutlet]="contentPlayer"
                            [ngTemplateOutletContext]="{s11Player:formationPlace.getPlayer()}">
                        </ng-container>
                        <span *ngIf="formationPlace.isSubstitute()" class="badge badge-reserve">r</span>
                    </div>
                </ng-container>
            </ng-template>

            <ng-template #contentForamtionPlaceScore let-formationPlace="formationPlace" let-sourceGame="sourceGame">
                <ng-container *ngIf="formationPlace">

                    <ng-container *ngIf="!formationPlace.isSubstitute();else substituteScore">

                        <ng-container *ngIf="sourceGame.getState() === Finished" [ngTemplateOutlet]="lineupScore"
                            [ngTemplateOutletContext]="{formationPlace, sourceGame}">
                        </ng-container>

                    </ng-container>
                    <ng-template #substituteScore>

                        <ng-container
                            *ngIf="formationPlace.getFormationLine().getStartingPlacesState(currentGameRound) === Finished">

                            <ng-container
                                *ngIf="formationPlace.getFormationLine().hasSubstituteAppareance(currentGameRound);else subDoesNotAppear">
                                <ng-container *ngIf="sourceGame.getState() === Finished"
                                    [ngTemplateOutlet]="lineupScore"
                                    [ngTemplateOutletContext]="{formationPlace, sourceGame}">
                                </ng-container>
                            </ng-container>
                            <ng-template #subDoesNotAppear>
                                <span class="badge text-bg-danger">
                                    <a
                                        [routerLink]="['/pool/sourcegame', pool.getId(), sourceGame.getGameRoundNumber(), sourceGame.getId()]">
                                        &nbsp;
                                    </a></span>
                            </ng-template>

                        </ng-container>

                    </ng-template>

                </ng-container>
            </ng-template>

            <ng-template #contentPlayer let-s11Player="s11Player">
                <span class="mx-1 text-break" *ngIf="s11Player">{{s11Player.getPerson().getName()}}</span>
            </ng-template>
        </div>
    </div>
</div>

<app-pool-navbar [current]="Competitions" *ngIf="pool" [pool]="pool" [poolUser]="poolUser">
</app-pool-navbar>

<ng-template #lineupScore let-formationPlace="formationPlace" let-sourceGame="sourceGame">

    <ng-container *ngIf="formationPlace.hasAppeared(currentGameRound);else startingNotAppeared">
        <span class="badge bg-points">
            <a [routerLink]="['/pool/sourcegame', pool.getId(), sourceGame.getGameRoundNumber(), sourceGame.getId()]">
                {{formationPlace.getPoints(currentGameRound)}}
            </a>
        </span>
    </ng-container>
    <ng-template #startingNotAppeared>
        <span class="badge bg-nopoints">
            <a [routerLink]="['/pool/sourcegame', pool.getId(), sourceGame.getGameRoundNumber(), sourceGame.getId()]">
                x
            </a></span>
    </ng-template>
</ng-template>